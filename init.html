<!DOCTYPE html>
<html>
<head>
    <title>åˆå§‹åŒ–æ•°æ®</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>åˆå§‹åŒ–GitHubæ•°æ®</h1>
    <button onclick="initData()">åˆå§‹åŒ–æ•°æ®</button>
    <div id="status"></div>

    <script>
        // ä¿®å¤Base64ç¼–ç é—®é¢˜
        function safeBtoa(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        // ç®€åŒ–çš„GitHubç®¡ç†å™¨
        class DataInitializer {
            constructor() {
                this.token = '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'; // æ›¿æ¢ä¸ºä½ çš„æ–°Token
                this.repo = 'zhou-str6668899/web-user-data';
                this.baseURL = 'https://api.github.com/repos/';
            }

            async updateFile(filePath, content) {
                // å°†å†…å®¹è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²ï¼Œç„¶åå®‰å…¨ç¼–ç 
                const jsonString = JSON.stringify(content, null, 2);
                const base64Content = safeBtoa(jsonString);

                const response = await fetch(`${this.baseURL}${this.repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Initialize ${filePath}`,
                        content: base64Content
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${errorData.message}`);
                }

                return await response.json();
            }

            async initData() {
                const status = document.getElementById('status');

                try {
                    status.innerHTML = '<div class="status">å¼€å§‹åˆå§‹åŒ–...</div>';

                    // 1. åˆ›å»ºç”¨æˆ·æ•°æ®ï¼ˆä½¿ç”¨è‹±æ–‡ç”¨æˆ·åé¿å…ç¼–ç é—®é¢˜ï¼‰
                    await this.updateFile('user/users.json', {
                        users: [{
                            id: "1",
                            email: "hawk@qq.com",
                            password: "123456",
                            username: "admin", // æ”¹ä¸ºè‹±æ–‡
                            registerDate: new Date().toISOString(),
                            lastLogin: null,
                            loginCount: 0,
                            status: "active",
                            role: "admin",
                            avatar: "",
                            verified: true
                        }]
                    });
                    status.innerHTML += '<div class="status success">âœ… ç”¨æˆ·æ•°æ®åˆ›å»ºæˆåŠŸ</div>';

                    // 2. åˆ›å»ºä¼šè¯æ•°æ®
                    await this.updateFile('sessions/active-sessions.json', {
                        sessions: []
                    });
                    status.innerHTML += '<div class="status success">âœ… ä¼šè¯æ•°æ®åˆ›å»ºæˆåŠŸ</div>';

                    // 3. åˆ›å»ºé…ç½®æ•°æ®
                    await this.updateFile('config/repository.config.json', {
                        repository: {
                            name: "web-user-data",
                            owner: "zhou-str6668899",
                            branch: "main"
                        },
                        security: {
                            adminEmails: ["hawk@qq.com"],
                            maxLoginAttempts: 5
                        }
                    });
                    status.innerHTML += '<div class="status success">âœ… é…ç½®æ•°æ®åˆ›å»ºæˆåŠŸ</div>';

                    status.innerHTML += '<div class="status success">ğŸ‰ æ‰€æœ‰æ•°æ®åˆå§‹åŒ–å®Œæˆï¼</div>';
                    status.innerHTML += '<div class="status success">ç°åœ¨å¯ä»¥æµ‹è¯•ç™»å½•ï¼šhawk@qq.com / 123456</div>';

                } catch (error) {
                    status.innerHTML += `<div class="status error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
                    console.error('è¯¦ç»†é”™è¯¯:', error);
                }
            }
        }

        const initializer = new DataInitializer();

        function initData() {
            initializer.initData();
        }

        // æµ‹è¯•ç¼–ç å‡½æ•°
        function testEncoding() {
            try {
                const testObj = { test: "ä¸­æ–‡æµ‹è¯•" };
                const encoded = safeBtoa(JSON.stringify(testObj));
                const decoded = JSON.parse(atob(encoded));
                console.log('âœ… ç¼–ç æµ‹è¯•é€šè¿‡:', decoded);
            } catch (error) {
                console.error('âŒ ç¼–ç æµ‹è¯•å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æµ‹è¯•ç¼–ç 
        document.addEventListener('DOMContentLoaded', testEncoding);
    </script>
</body>
</html>